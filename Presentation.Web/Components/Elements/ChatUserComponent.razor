@using Presentation.Web.Models
@using Presentation.Web.State.User
@inject IUserService UserService
<MudItem xs="12" md="4" Class="d-flex flex-column" Style="height: 100%;">
    <MudText Typo="Typo.h6" Class="mb-2">Contacts</MudText>
    <MudTextField @bind-Value="_searchQuery"
                  Placeholder="Search..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Margin="Margin.Dense"
                  Class="mb-4"
                  Immediate="true"/>

    <div class="flex-grow-1 overflow-y-auto">
        <MudList T="UserModel" clickable="true">
            @foreach (var user in FilteredUsers)
            {
                <MudListItem Text="@user.FullName"
                             OnClick="@(() => SelectUser(user))"
                             Icon="@Icons.Material.Filled.Person"/>
            }
        </MudList>
    </div>
</MudItem>

@code {
    [Parameter] public EventCallback<UserModel?> OnUserSelected { get; set; }

    private string _searchQuery = string.Empty;
    private UserModel? _selectedUser;

    private IEnumerable<UserModel> FilteredUsers =>
        string.IsNullOrWhiteSpace(_searchQuery)
            ? UserService.Users
            : UserService.Users.Where(u => u.FullName.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await UserService.InitializeAsync();
        UserService.OnCollectionChanged += () =>
        {
            InvokeAsync(StateHasChanged);
            return Task.CompletedTask;
        };
    }

    private async Task SelectUser(UserModel? user)
    {
        _selectedUser = user;
        await OnUserSelected.InvokeAsync(_selectedUser);
        await InvokeAsync(StateHasChanged);
    }

}